name: Sync Alist Release Assets

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

jobs:
  sync-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout NewAlist upstream
        uses: actions/checkout@v4
        with:
          repository: NewAlist/alist
          path: upstream

      - name: Download release assets
        run: |
          mkdir -p root
          cd upstream
          for TAG in $(git tag); do
            mkdir -p "../root/$TAG"
            gh release download "$TAG" --repo NewAlist/alist -D "../root/$TAG"
          done

      - name: Sync assets to my repo
        uses: at-wat/assets-sync-action@v0.6.7
        with:
          repos: ice345/alist
          github_token: ${{ secrets.GITHUB_TOKEN }}
          git_user: ice345-bot
          git_email: ice345@example.com
          commit_message: "Sync Alist release assets from NewAlist/alist"
          branch: sync-release-assets
          root_dir: root

      - name: Create GitHub Release
        run: |
          TAG_NAME="v$(date +'%Y%m%d%H%M%S')"
          gh release create "$TAG_NAME" --title "Release $TAG_NAME" --notes "Automated release created by GitHub Actions" --target sync-release-assets

      - name: Cleanup
        run: rm -rf root upstream
