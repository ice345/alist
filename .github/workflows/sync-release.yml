name: Build and Release Alist

on:
  workflow_dispatch:
  schedule:
    - cron: '0 3 * * *'

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.20'  # 根据Alist需要设置go版本

      - name: Clean Go module cache and dependencies
        run: |
          go clean -modcache
          rm -f go.sum
          go mod tidy

      - name: Build Linux amd64 binary
        run: |
          GOOS=linux GOARCH=amd64 go build -o alist-linux-amd64 ./cmd/alist

      - name: Build Windows amd64 binary
        run: |
          GOOS=windows GOARCH=amd64 go build -o alist-windows-amd64.exe ./cmd/alist

      - name: Build macOS amd64 binary
        run: |
          GOOS=darwin GOARCH=amd64 go build -o alist-darwin-amd64 ./cmd/alist

      - name: Set tag name
        run: echo "TAG_NAME=v$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV

      - name: Create git tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag $TAG_NAME
          git push origin $TAG_NAME

      - name: Create GitHub Release and upload binaries
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: Release ${{ env.TAG_NAME }}
          body: Automated release created by GitHub Actions
          files: |
            alist-linux-amd64
            alist-windows-amd64.exe
            alist-darwin-amd64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        run: rm -f alist-linux-amd64 alist-windows-amd64.exe alist-darwin-amd64
