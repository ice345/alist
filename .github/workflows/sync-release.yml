name: Sync Alist Release Assets

on:
  workflow_dispatch:         # 支持手动触发
  schedule:
    - cron: '0 3 * * *'      # 每天 03:00 UTC 自动运行（约新加坡时间 11:00）

jobs:
  sync-assets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4

      - name: Checkout NewAlist upstream
        uses: actions/checkout@v4
        with:
          repository: NewAlist/alist
          path: upstream

      - name: Download release assets
        run: |
          mkdir -p root
          cd upstream
          # 遍历所有 tags，下载对应 assets 到 ../root/<tag>/
          for TAG in $(git tag); do
            mkdir -p "../root/$TAG"
            gh release download "$TAG" --repo NewAlist/alist -D "../root/$TAG"
          done

      - name: Sync assets to my repo
        uses: at-wat/assets-sync-action@v0.6.7
        with:
          repos: ice345/alist
          github_token: ${{ secrets.GH_TOKEN }}
          git_user: ice345-bot
          git_email: ice345@example.com
          commit_message: "Sync Alist release assets from NewAlist/alist"
          branch: sync-release-assets
          root_dir: root

      - name: Cleanup
        run: rm -rf root upstream
